<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Airea | Jury de nez</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: sans-serif; margin: 0; padding-bottom: 60px; }
    header {
      background: #3f51b5; color: white;
      padding: 1rem;
      display: flex; justify-content: space-between; align-items: center;
    }
    header h1 { margin: 0; font-size: 1.1rem; }
    header button {
      background: #eee; border: none; padding: .5rem 1rem;
      border-radius: 4px; font-size: .9rem;
    }
    main { padding: 1rem; }
    label { display: block; margin-bottom: .5rem; font-size: .9rem; }
    select, input[type="time"], input[type="number"], input[type="text"], textarea {
      width: 100%; padding: .4rem; font-size: .9rem;
      margin-top: .2rem; box-sizing: border-box;
    }
    .row { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; }
    .row > div { flex: 1 1 120px; }
    #notes .note-row {
      display: flex; align-items: center; padding: .5rem;
      gap: .5rem; border-radius: 4px; margin-bottom: .3rem;
    }
    #notes .note-row label { margin: 0; flex: 1 1 100px; font-size: .85rem; }
    #notes .note-row select, #notes .note-row input {
      flex: 0 1 60px; padding: .3rem;
    }
    textarea { height: 4rem; }
    footer {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: white; padding: .5rem 1rem;
      display: flex; gap: .5rem;
    }
    footer button {
      flex: 1; padding: .8rem; font-size: 1rem; border: none;
      border-radius: 4px;
    }
    #add { background: #ccc; }
    #download { background: #e53935; color: white; }
  </style>
</head>
<body>

  <header>
    <h1>Airea | Jury de nez</h1>
    <button id="new">New</button>
  </header>

  <main>

    <p>Appuie ici pour démarrer une nouvelle mesure</p>

    <div class="row">
      <div>
        <label>Point de mesure
          <select id="point"></select>
        </label>
      </div>
      <div>
        <label>Session
          <select id="session">
            <option>AM</option>
            <option>PM</option>
          </select>
        </label>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Heure
          <input type="time" id="heure" value="12:00">
        </label>
      </div>
      <div>
        <label>Direction
          <input type="text" id="ventDir" value="NE">
        </label>
      </div>
      <div>
        <label>Vitesse (m/s)
          <input type="number" id="ventVit" min="0" step="0.1" value="0">
        </label>
      </div>
    </div>

    <h2>Intensités d'odeurs</h2>
    <div id="notes"></div>

    <label>Commentaires :
      <textarea id="commentaire"></textarea>
    </label>

  </main>

  <footer>
    <button id="add">Ajout des données de PX</button>
    <button id="download">Tout exporter en csv</button>
  </footer>

  <script>
  // --- données en mémoire ---
  const data = JSON.parse(localStorage.getItem('mesures') || '[]');

  // 1) peupler le <select> des points P1…P20
  const pointSel = document.getElementById('point');
  for (let i = 1; i <= 20; i++) {
    const opt = document.createElement('option');
    opt.value = 'P' + i;
    opt.textContent = 'P' + i;
    pointSel.appendChild(opt);
  }

  // 2) définir les catégories avec leur couleur d'arrière-plan
  const categories = [
    { nom: 'Nature (A)',      code:'A', bg:'#00c853' },
    { nom: 'Routier (B)',     code:'B', bg:'#b0bec5' },
    { nom: 'Agriculture (C)', code:'C', bg:'#8d6e63' },
    { nom: 'Méthaniseur (D)', code:'D', bg:'#d50000' },
    { nom: 'Cuisine (E)',     code:'E', bg:'#ffeb3b' },
    { nom: 'Déchets (F)',     code:'F', bg:'#e040fb' },
    { nom: 'Eaux usées (G)',  code:'G', bg:'#00e5ff' },
    { nom: 'Fumée (H)',       code:'H', bg:'#546e7a' },
    { nom: 'Industrie (I)',   code:'I', bg:'#ff8a80' },
    { nom: 'Autre (J)',       code:'J', bg:'#ffc107' },
  ];

  // 3) générer les lignes A→J
  const notesDiv = document.getElementById('notes');
  categories.forEach(cat => {
    const row = document.createElement('div');
    row.className = 'note-row';
    row.style.background = cat.bg;
    row.innerHTML = `
      <label>${cat.nom} Continu
        <select id="cont_${cat.code}">
          ${[...Array(51)].map((_,i)=>`<option>${(i*0.1).toFixed(1)}</option>`).join('')}
        </select>
      </label>
      <label>Bouffées
        <select id="bouf_${cat.code}">
          ${[...Array(51)].map((_,i)=>`<option>${(i*0.1).toFixed(1)}</option>`).join('')}
        </select>
      </label>
    `;
    notesDiv.appendChild(row);
  });

  // raccourci pour récupérer valeur
  const $ = id => document.getElementById(id).value;

  // utils
  function save() {
    localStorage.setItem('mesures', JSON.stringify(data));
  }
  function alertMsg(txt) { alert(txt); }

  // reset formulaire
  function resetForm() {
    pointSel.value = 'P1';
    document.getElementById('session').value = 'AM';
    document.getElementById('heure').value = '12:00';
    document.getElementById('ventDir').value = 'NE';
    document.getElementById('ventVit').value = '0';
    categories.forEach(cat => {
      document.getElementById(`cont_${cat.code}`).value = '0.0';
      document.getElementById(`bouf_${cat.code}`).value = '0.0';
    });
    document.getElementById('commentaire').value = '';
  }

  // bouton New
  document.getElementById('new').onclick = resetForm;

  // bouton Ajouter
  document.getElementById('add').onclick = () => {
    const row = [
      $('point'),
      $('session'),
      $('heure'),
      $('ventDir'),
      $('ventVit')
    ];
    categories.forEach(cat => {
      row.push($(`cont_${cat.code}`));
      row.push($(`bouf_${cat.code}`));
    });
    row.push(document.getElementById('commentaire').value.trim());
    data.push(row);
    save();
    alertMsg('Mesure enregistrée');
  };

  // bouton Télécharger CSV
  document.getElementById('download').onclick = () => {
    if (data.length === 0) return alertMsg('Aucune donnée à exporter');
    // en-têtes
    const headers = [
      'Point','Session','Heure','DirectionVent','VitesseVent',
      ...categories.flatMap(cat => [
        `Intensite_${cat.code}_continu`,
        `Intensite_${cat.code}_bousee`
      ]),
      'Commentaire'
    ];
    // assembler CSV
    const csv = [
      headers.join(','),
      ...data.map(r => r.map(v => `"${v.replace(/"/g,'""')}"`).join(','))
    ].join('\r\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href = url; a.download = 'mesures.csv';
    a.click();
    URL.revokeObjectURL(url);
  };
  </script>

</body>
</html>
