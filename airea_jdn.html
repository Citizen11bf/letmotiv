<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Airea | Jury de nez</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: sans-serif; margin: 0; padding-bottom: 50px; }
    header {
      background: #3f51b5;
      color: white;
      padding: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 { margin: 0; font-size: 1.2rem; }
    main { padding: 0.5rem 1rem; }
    .grid2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    label { display: block; font-size: .85rem; }
    select, input[type="time"], input[type="number"], input[type="text"], textarea {
      width: 100%; padding: .4rem; font-size: .85rem;
      margin-top: .2rem; box-sizing: border-box;
    }
    #notes .note-row {
      display: flex; align-items: center; padding: .3rem;
      gap: .3rem; border-radius: 4px; margin-bottom: .2rem;
      flex-wrap: wrap;
    }
    #notes .note-row > div.title {
      flex-basis: 100%;
    }
    #notes .note-row > div.title strong {
      font-size: .9rem;
    }
    #notes .note-row label { margin: 0; flex: 1; font-size: .8rem; }
    #notes .note-row select { flex: 0 0 50px; padding: .2rem; font-size: .8rem; }
    textarea { height: 3rem; font-size: .85rem; }
    footer {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: #3f51b5;
      padding: .3rem 1rem;
      display: flex; gap: .3rem;
    }
    footer button {
      flex: 1; padding: .6rem; font-size: .9rem; border: none;
      border-radius: 4px; color: white;
    }
    #add { background: #757575; }
    #download { background: #e53935; }
    .jury-container label { margin-right: .5rem; }
  </style>
</head>
<body>

  <header>
    <h1>Airea | Jury de nez</h1>
    <div class="jury-container">
      <label for="jury">Jury</label>
      <select id="jury">
        <option value="BF">Benjamin F</option>
        <option value="FC">François C</option>
        <option value="NG">Natalia G</option>
        <option value="VL">Valentin L</option>
        <option value="VP">Vincent P</option>
      </select>
    </div>
  </header>

  <main>

    <div class="grid2">
      <div>
        <label>Point de mesure
          <select id="point"></select>
        </label>
      </div>
      <div style="display:flex; align-items:flex-end; justify-content:flex-end;">
        <button id="new">Démarrer une nouvelle mesure</button>
      </div>
    </div>

    <div class="grid2">
      <div>
        <label>Session
          <select id="session">
            <option>AM</option><option>PM</option>
          </select>
        </label>
      </div>
      <div>
        <label>Heure
          <input type="time" id="heure">
        </label>
      </div>
    </div>

    <div class="grid2">
      <div>
        <label>Direction du vent
          <input type="text" id="ventDir">
        </label>
      </div>
      <div>
        <label>Vitesse du vent (m/s)
          <input type="number" id="ventVit" min="0" step="0.1">
        </label>
      </div>
    </div>

    <div id="notes"></div>

    <label>Commentaires :
      <textarea id="commentaire"></textarea>
    </label>

  </main>

  <footer>
    <button id="add">Ajout des données de P1</button>
    <button id="download">Tout exporter en csv</button>
  </footer>

  <script>
  // stockage en map point_session → row
  let dataMap = JSON.parse(localStorage.getItem('mesuresMap') || '{}');
  let saved = true;
  let editingKey = null;

  // références
  const pointSel   = document.getElementById('point');
  const sessionSel = document.getElementById('session');
  const jurySel    = document.getElementById('jury');
  const addBtn     = document.getElementById('add');

  // 1) remplir P1…P20
  for (let i = 1; i <= 20; i++) {
    const o = document.createElement('option');
    o.value = o.textContent = 'P' + i;
    pointSel.appendChild(o);
  }

  // 2) catégories & couleurs pastel
  const categories = [
    { nom:'Nature (A)',      code:'A', bg:'#a8e6cf' },
    { nom:'Routier (B)',     code:'B', bg:'#cfd8dc' },
    { nom:'Agriculture (C)', code:'C', bg:'#d7ccc8' },
    { nom:'Méthaniseur (D)', code:'D', bg:'#ff8a80' },
    { nom:'Cuisine (E)',     code:'E', bg:'#fff9c4' },
    { nom:'Déchets (F)',     code:'F', bg:'#f8bbd0' },
    { nom:'Eaux usées (G)',  code:'G', bg:'#b2ebf2' },
    { nom:'Fumée (H)',       code:'H', bg:'#cfd8dc' },
    { nom:'Industrie (I)',   code:'I', bg:'#ffccbc' },
    { nom:'Autre (J)',       code:'J', bg:'#ffe082' },
  ];
  const notesDiv = document.getElementById('notes');
  categories.forEach(cat => {
    const row = document.createElement('div');
    row.className = 'note-row';
    row.style.background = cat.bg;
    row.innerHTML = `
      <div class="title"><strong>${cat.nom}</strong></div>
      <label>Continu
        <select id="cont_${cat.code}">
          ${[...Array(13)].map((_,i)=>`<option>${(i*0.5).toFixed(1)}</option>`).join('')}
        </select>
      </label>
      <label>Bouffées
        <select id="bouf_${cat.code}">
          ${[...Array(13)].map((_,i)=>`<option>${(i*0.5).toFixed(1)}</option>`).join('')}
        </select>
      </label>`;
    notesDiv.appendChild(row);
  });

  // raccourcis
  const $val = id => document.getElementById(id).value;

  // utilitaires
  function saveMap() {
    localStorage.setItem('mesuresMap', JSON.stringify(dataMap));
  }
  function getNowHM() {
    return new Date().toTimeString().slice(0,5);
  }
  function updateAddLabel() {
    if (editingKey) {
      addBtn.textContent = `Mettre à jour ${pointSel.value}`;
    } else {
      addBtn.textContent = `Ajout des données de ${pointSel.value}`;
    }
  }
  function markDirty() {
    saved = false;
  }

  // charger si déjà saisi
  function loadIfExists() {
    const key = `${pointSel.value}_${sessionSel.value}`;
    if (dataMap[key]) {
      const row = dataMap[key];
      document.getElementById('heure').value   = row[2];
      document.getElementById('ventDir').value = row[3];
      document.getElementById('ventVit').value = row[4];
      categories.forEach((cat,i) => {
        document.getElementById(`cont_${cat.code}`).value = row[5 + 2*i];
        document.getElementById(`bouf_${cat.code}`).value = row[5 + 2*i + 1];
      });
      document.getElementById('commentaire').value = row[row.length -1];
      editingKey = key;
    } else {
      editingKey = null;
      resetFormFields();
    }
    updateAddLabel();
    saved = true;
  }

  // reset champs (heure à now, autres à 0/vide)
  function resetFormFields() {
    document.getElementById('session').value = 'AM';
    document.getElementById('heure').value   = getNowHM();
    document.getElementById('ventDir').value = '';
    document.getElementById('ventVit').value = '0';
    categories.forEach(cat => {
      document.getElementById(`cont_${cat.code}`).value = '0.0';
      document.getElementById(`bouf_${cat.code}`).value = '0.0';
    });
    document.getElementById('commentaire').value = '';
  }

  // reset complet avec confirmation
  function resetForm() {
    if (!saved && !confirm("As-tu bien enregistré les données du point précédent ?")) {
      return;
    }
    pointSel.value = 'P1';
    resetFormFields();
    saved = true;
    editingKey = null;
    updateAddLabel();
  }

  // initialisation
  window.addEventListener('load', () => {
    resetForm();
    loadIfExists();
  });

  // écouteurs
  pointSel.addEventListener('change', () => { loadIfExists(); markDirty(); });
  sessionSel.addEventListener('change', () => { loadIfExists(); markDirty(); });
  document.querySelectorAll('select,input,textarea').forEach(el => {
    el.addEventListener('input', markDirty);
    el.addEventListener('change', markDirty);
  });
  document.getElementById('new').onclick = resetForm;

  // Ajouter / mettre à jour
  addBtn.onclick = () => {
    const key = `${pointSel.value}_${sessionSel.value}`;
    const row = [
      $val('point'),
      $val('session'),
      $val('heure'),
      $val('ventDir'),
      $val('ventVit'),
      ...categories.flatMap(cat => [
        $val(`cont_${cat.code}`),
        $val(`bouf_${cat.code}`)
      ]),
      document.getElementById('commentaire').value.trim()
    ];
    dataMap[key] = row;
    saveMap();
    saved = true;
    alert(editingKey ? 'Mesure mise à jour' : 'Mesure enregistrée');
    editingKey = key;
    updateAddLabel();
  };

  // export CSV
  document.getElementById('download').onclick = () => {
    const rows = Object.values(dataMap);
    if (rows.length === 0) return alert('Aucune donnée à exporter');
    const juryCode = jurySel.value;
    const filename = `JDN_${juryCode}.csv`;
    const headers = [
      'Point','Session','Heure','DirectionVent','VitesseVent',
      ...categories.flatMap(c => [`Intensite_${c.code}_continu`,`Intensite_${c.code}_bousee`]),
      'Commentaire'
    ];
    const csv = [
      headers.join(','),
      ...rows.map(r => r.map(v => `"${v.replace(/"/g,'""')}"`).join(','))
    ].join('\r\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href = url; a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  };
  </script>

</body>
</html>
