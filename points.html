<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Terrain Air Quality</title>
  <style>
    :root {
      --airea-blue: #005fa1;
      --airea-light: #e6f2fa;
      --text-dark: #333;
      --footer-height: 3.5rem;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: sans-serif;
      background: var(--airea-light);
      color: var(--text-dark);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      background: var(--airea-blue);
      color: #fff;
      text-align: center;
      padding: 0.25rem;
    }
    header h1 { font-size: 1.2rem; line-height: 1.5; }
    main {
      flex: 1;
      overflow-y: auto;
      padding: 0.75rem;
      margin-bottom: var(--footer-height);
    }
    .row { margin-bottom: 0.5rem; display: flex; flex-direction: column; }
    .row label { margin-bottom: 0.25rem; font-size: 0.9rem; }
    select, input { padding: 0.4rem; border:1px solid #ccc; border-radius:4px; font-size:0.9rem; }
    .coords { display:flex; gap:0.5rem; }
    .coords>div { flex:1; }
    .photos { display:flex; gap:0.5rem; }
    .photos button {
      flex:1; padding:0.5rem; border:1px dashed #777; border-radius:4px;
      background:#fff; font-size:0.9rem; transition:0.2s;
    }
    .photos button.filled { background:var(--airea-blue); color:#fff; border:none; }
    .sensors { display:grid; grid-template-columns:repeat(auto-fit,minmax(80px,1fr)); gap:0.5rem; }
    .buttons { display:flex; gap:0.5rem; margin-top:0.75rem; }
    button, .export-btn {
      padding:0.6rem; background:var(--airea-blue); color:#fff; border:none;
      border-radius:6px; font-size:1rem; cursor:pointer;
    }
    button:active { opacity:0.8; }
    footer {
      position:fixed; bottom:0; left:0; width:100%; height:var(--footer-height);
      background:var(--airea-blue); display:flex; align-items:center;
      justify-content:center; padding:0.5rem;
    }
    footer .export-btn { width:100%; font-size:0.95rem; }
  </style>
</head>
<body>
  <header><h1>Airea – Qualité de l'air</h1></header>

  <main>
    <form id="pointForm">
      <div class="row">
        <label for="pointSelect">Point de mesure</label>
        <select id="pointSelect"><option value="">-- Choisir --</option></select>
      </div>
      <div class="buttons">
        <button type="button" id="btnGeo">Obtenir adresse et coordonnées</button>
      </div>
      <div class="row">
        <label for="address">Adresse</label>
        <input type="text" id="address" readonly>
      </div>
      <div class="row coords">
        <div>
          <label for="latDMS">Latitude (DMS)</label>
          <input type="text" id="latDMS" readonly>
        </div>
        <div>
          <label for="lngDMS">Longitude (DMS)</label>
          <input type="text" id="lngDMS" readonly>
        </div>
      </div>
      <div class="row photos">
        <button type="button" id="photo1Btn">Photo1</button>
        <button type="button" id="photo2Btn">Photo2</button>
        <input type="file" accept="image/*" capture="environment" id="photo1" style="display:none">
        <input type="file" accept="image/*" capture="environment" id="photo2" style="display:none">
      </div>
      <div class="row sensors">
        <div><label for="no2">Capteur NO₂</label><input type="number" id="no2" required></div>
        <div><label for="c6h6">Capteur C₆H₆</label><input type="number" id="c6h6" required></div>
        <div><label for="pm10">Capteur PM₁₀</label><input type="number" id="pm10" required></div>
      </div>
      <div class="row">
        <label for="datetime">Date & heure</label>
        <input type="datetime-local" id="datetime" required>
      </div>
      <div class="buttons">
        <button type="button" id="savePoint"><span id="saveLabel">Enregistrement</span></button>
      </div>
    </form>
  </main>

  <footer>
    <button type="button" class="export-btn" id="exportXlsx">Export en .xlsx</button>
  </footer>

  <!-- Librairies externes -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const points      = {};
    const selectors   = ['pointSelect','btnGeo','savePoint','exportXlsx'];
    const [pointSelect,btnGeo,btnSave,btnExport] = selectors.map(id=>document.getElementById(id));
    const saveLabel   = document.getElementById('saveLabel');
    const addressEl   = document.getElementById('address');
    const latEl       = document.getElementById('latDMS');
    const lngEl       = document.getElementById('lngDMS');
    const no2El       = document.getElementById('no2');
    const c6h6El      = document.getElementById('c6h6');
    const pm10El      = document.getElementById('pm10');
    const datetimeEl  = document.getElementById('datetime');
    const photo1      = document.getElementById('photo1');
    const photo2      = document.getElementById('photo2');
    const photo1Btn   = document.getElementById('photo1Btn');
    const photo2Btn   = document.getElementById('photo2Btn');

    // Spinner P1→P40
    for(let i=1;i<=40;i++) pointSelect.add(new Option(`P${i}`,`P${i}`));

    const toDMS = v=>{
      const deg=Math.floor(v), min=Math.floor((v-deg)*60),
            sec=Math.round((v-deg-min/60)*3600);
      return `${deg}°${min}'${sec}"`;
    };

    function clearFields(){
      [addressEl,latEl,lngEl,no2El,c6h6El,pm10El,datetimeEl].forEach(el=>el.value='');
      photo1Btn.textContent='Photo1';
      photo2Btn.textContent='Photo2';
      photo1Btn.classList.remove('filled');
      photo2Btn.classList.remove('filled');
    }

    function loadPoint(key){
      clearFields();
      saveLabel.textContent = key ? (points[key] ? `Mettre à jour ${key}` : `Enregistrement ${key}`) : 'Enregistrement';
      if(points[key]){
        const p=points[key];
        addressEl.value=p.address; latEl.value=p.lat; lngEl.value=p.lng;
        no2El.value=p.no2; c6h6El.value=p.c6h6; pm10El.value=p.pm10;
        datetimeEl.value=p.datetime;
        if(p.b64_1){ photo1Btn.textContent=p.photo1Name; photo1Btn.classList.add('filled'); }
        if(p.b64_2){ photo2Btn.textContent=p.photo2Name; photo2Btn.classList.add('filled'); }
      }
    }

    pointSelect.addEventListener('change', ()=>loadPoint(pointSelect.value));

    btnGeo.addEventListener('click', ()=>{
      if(!navigator.geolocation) return alert("Géoloc non supportée");
      navigator.geolocation.getCurrentPosition(async pos=>{
        const {latitude,longitude}=pos.coords;
        const res=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
        const d=await res.json();
        addressEl.value=d.display_name;
        latEl.value=toDMS(latitude);
        lngEl.value=toDMS(longitude);
      },e=>alert("Erreur position: "+e.message));
    });

    // prise de photos corrigées selon orientation EXIF
    async function handleFile(file, btn){
      // lire orientation
      const arrayBuf = await file.arrayBuffer();
      let orientation = 1;
      EXIF.getData({src:arrayBuf}, function(){ orientation = EXIF.getTag(this,'Orientation')||1; });
      // charger image
      const imgURL = URL.createObjectURL(file);
      const img = await new Promise(r=>{ let i=new Image();i.onload=()=>r(i);i.src=imgURL; });
      // canvas
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      // si portrait, on inverse dims
      const w = img.naturalWidth, h = img.naturalHeight;
      if(orientation>4) { canvas.width=h; canvas.height=w; }
      else { canvas.width=w; canvas.height=h; }
      // appliquer rotation selon orientation
      switch(orientation){
        case 2: ctx.transform(-1,0,0,1,w,0); break;
        case 3: ctx.transform(-1,0,0,-1,w,h); break;
        case 4: ctx.transform(1,0,0,-1,0,h); break;
        case 5: ctx.transform(0,1,1,0,0,0); break;
        case 6: ctx.transform(0,1,-1,0,h,0); break;
        case 7: ctx.transform(0,-1,-1,0,h,w); break;
        case 8: ctx.transform(0,-1,1,0,0,w); break;
      }
      ctx.drawImage(img,0,0);
      URL.revokeObjectURL(imgURL);
      // redimensionner à 7×5,25 cm → px@96dpi
      const pxPerCm = 96/2.54;
      const targetW = Math.round(7*pxPerCm), targetH = Math.round(5.25*pxPerCm);
      const tmp = document.createElement('canvas');
      tmp.width=targetW; tmp.height=targetH;
      tmp.getContext('2d').drawImage(canvas,0,0,targetW,targetH);
      // base64
      const b64 = tmp.toDataURL(`image/${file.name.split('.').pop()}`).split(',')[1];
      btn.classList.add('filled');
      return b64;
    }

    photo1Btn.addEventListener('click', ()=>photo1.click());
    photo2Btn.addEventListener('click', ()=>photo2.click());
    photo1.addEventListener('change', async ()=>{
      if(photo1.files[0]){
        photo1Btn.textContent=photo1.files[0].name;
        photo1Btn.classList.add('filled');
      }
    });
    photo2.addEventListener('change', async ()=>{
      if(photo2.files[0]){
        photo2Btn.textContent=photo2.files[0].name;
        photo2Btn.classList.add('filled');
      }
    });

    btnSave.addEventListener('click', async ()=>{
      const key = pointSelect.value;
      if(!key) return alert("Sélectionne un point.");
      // traiter photos
      const p1 = photo1.files[0] ? await handleFile(photo1.files[0], photo1Btn) : null;
      const p2 = photo2.files[0] ? await handleFile(photo2.files[0], photo2Btn) : null;
      points[key] = {
        address: addressEl.value, lat: latEl.value, lng: lngEl.value,
        no2: no2El.value, c6h6: c6h6El.value, pm10: pm10El.value,
        datetime: datetimeEl.value,
        photo1Name: photo1.files[0]?.name||'', photo2Name: photo2.files[0]?.name||'',
        b64_1: p1, b64_2: p2
      };
      alert(`Données ${key} enregistrées !`);
      // prochain libre
      let next='';
      for(let i=1;i<=40;i++) if(!points[`P${i}`]){ next=`P${i}`;break; }
      pointSelect.value=next; loadPoint(next);
    });

    btnExport.addEventListener('click', async ()=>{
      const wb=new ExcelJS.Workbook();
      const ws=wb.addWorksheet('Mesures');
      ws.columns=[
        {header:'Point',key:'point',width:10},
        {header:'Adresse',key:'address',width:30},
        {header:'Lat DMS',key:'lat',width:15},
        {header:'Lng DMS',key:'lng',width:15},
        {header:'Photo1',key:'photo1',width:35.7},
        {header:'Photo2',key:'photo2',width:35.7},
        {header:'NO2',key:'no2',width:10},
        {header:'C6H6',key:'c6h6',width:10},
        {header:'PM10',key:'pm10',width:10},
        {header:'DateHeure',key:'datetime',width:20},
      ];
      ws.getColumn('datetime').numFmt='dd/mm/yy hh:mm';
      const pxPerCm=96/2.54, imgW=Math.round(7*pxPerCm), imgH=Math.round(5.25*pxPerCm);
      let ri=2;
      for(const [pt,p] of Object.entries(points)){
        ws.addRow({
          point:pt,address:p.address,lat:p.lat,lng:p.lng,
          photo1:'',photo2:'',no2:p.no2,c6h6:p.c6h6,pm10:p.pm10,
          datetime:new Date(p.datetime)
        });
        ws.getRow(ri).height = Math.round(340*0.75); // 340px → pts
        if(p.b64_1){
          const id1=wb.addImage({base64:p.b64_1,extension:p.photo1Name.split('.').pop()});
          ws.addImage(id1,{tl:{col:4,row:ri-1},ext:{width:imgW,height:imgH}});
        }
        if(p.b64_2){
          const id2=wb.addImage({base64:p.b64_2,extension:p.photo2Name.split('.').pop()});
          ws.addImage(id2,{tl:{col:5,row:ri-1},ext:{width:imgW,height:imgH}});
        }
        ri++;
      }
      const buf=await wb.xlsx.writeBuffer();
      saveAs(new Blob([buf],{type:'application/octet-stream'}),'mesures_air_avec_photos.xlsx');
    });

    // init
    pointSelect.value=''; loadPoint('');
  });
  </script>
</body>
</html>
