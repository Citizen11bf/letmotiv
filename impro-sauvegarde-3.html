<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Simulateur d'improvisation</title>
  <meta name="description" content="Évaluer et développer rapidement votre niveau en prise de parole en public avec le simulateur d'improvisation Letmotiv.">

  <!-- Balises Open Graph et Twitter (inchangées) -->
  <!-- … -->

  <!-- Import de Google Fonts et Font Awesome -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=DM+Sans&family=Montserrat:wght@700&display=swap"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
  />

  <style>
    /* --- GLOBAL --- */
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'DM Sans', sans-serif;
      background-color: #ffffff;
      color: #333333;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      overflow-x: hidden;
      padding-top: 60px;  /* Compense le header fixe */
      padding-bottom: 20px;
    }

    /* --- HEADER --- */
    .header {
      background-color: #182d84;
      color: #FFFFFF;
      font-size: 16px;
      font-weight: bold;
      text-align: center;
      padding: 10px;
      width: 100%;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 10;
    }
    .header-content { /* … styles inchangés … */ }

    /* --- BARRE DE PROGRESSION --- */
    .progress-container {
      position: fixed;
      top: 60px; 
      left: 0;
      width: 100%;
      height: 8px;
      background-color: rgba(24, 45, 132, 0.1);
      z-index: 9;
    }
    .progress-bar {
      width: 0%;
      height: 100%;
      background-color: #00a48a;
      transition: width 0.5s ease;
    }

    /* --- STYLE DES BOXES --- */
    .box {
      position: relative;
      width: 100%;
      max-width: 600px;
      margin: 20px 0;
      background-color: #E2E7E3;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0px 4px 6px rgba(0,0,0,0.1);
      text-align: center;
      font-size: 14px;
      border: 2px solid #eeeeee;
      display: none;
    }
    .box.active { display: block; }

    /* --- ANIMATIONS --- */
    .slide-from-bottom { animation: fromBottom 1.5s ease forwards; }
    @keyframes fromBottom {
      from { opacity: 0; transform: translateY(50px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .slide-from-top { animation: fromTop 1.5s ease forwards; }
    @keyframes fromTop {
      from { opacity: 0; transform: translateY(-50px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

    /* --- BOUTONS --- */
    .back-btn, .next-btn, button {
      /* Styles communs (border, padding, transition, etc.) */
    }
    .back-btn {
      background-color: #808080;
      color: #FFFFFF;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.3s;
    }
    .back-btn.hidden-visibility { visibility: hidden; }
    .next-btn {
      width: 40px;
      height: 40px;
      border: 2px solid #182d84;
      background-color: transparent;
      color: #182d84;
      border-radius: 50%;
      cursor: pointer;
      transition: background-color 0.3s, color 0.3s, transform 0.3s;
      margin: 10px auto;
    }
    .next-btn:hover { background-color: #00a48a; color: #ffffff; transform: scale(1.05); }

    /* --- BOX D'INTRODUCTION --- */
    .intro-box {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #182d84, #00a48a);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: #ffffff;
      z-index: 20;
      animation: fadeIn 1s ease forwards;
    }
    .intro-box h1 {
      font-family: 'Montserrat', sans-serif;
      font-size: 2.5rem;
      margin-bottom: 30px;
      animation: slideDown 1s ease forwards;
    }
    .intro-box button {
      background-color: #ffffff;
      color: #182d84;
      border: none;
      border-radius: 25px;
      padding: 15px 30px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.3s, color 0.3s;
      box-shadow: 0px 4px 6px rgba(0,0,0,0.2);
    }
    .intro-box button:hover { background-color: #00a48a; color: #ffffff; transform: scale(1.05); }
    @keyframes slideDown {
      from { transform: translateY(-50px); opacity: 0; }
      to   { transform: translateY(0); opacity: 1; }
    }

    /* --- BOX STEP1 : Choix d’objectif --- */
    /* (inchangé) */

    /* --- NOUVELLE BOX STEP2 : Génère un sujet d’improvisation --- */
    #step2-subject p#objective-reminder {
      font-weight: bold;
      margin-bottom: 15px;
    }
    #subject-result {
      margin-top: 10px;
      font-weight: bold;
      font-size: 16px;
    }

    /* --- BOX STEP3 : Vidéo Impro (anciennement step2) --- */
    /* On ajoute un conteneur pour afficher le sujet généré */
    #subject-display-video {
      margin: 10px 0;
      font-weight: bold;
      font-size: 16px;
    }

    /* … Le reste des styles (pour les boxes STEP4 et STEP3 dans l’ordre final) reste inchangé … */
    
    /* (Les styles pour les autres sections, formulaires, etc. restent tels quels) */

  </style>
</head>
<body>
  <!-- BOÎTE D'INTRODUCTION (inchangée) -->
  <div class="intro-box" id="intro-box">
    <h1>Entraine-toi à la prise de parole en public</h1>
    <button id="start-intro-btn" aria-label="Commencer">Commencer</button>
  </div>

  <!-- FORMULAIRE CACHÉ POUR GOOGLE FORMS (inchangé) -->
  <!-- … -->

  <!-- HEADER -->
  <div class="header">
    <div class="header-content">
      <div class="header-l1">Simulateur d'improvisation en public</div>
      <div class="header-l2">by Letmotiv</div>
    </div>
  </div>

  <!-- BARRE DE PROGRESSION -->
  <div class="progress-container">
    <div class="progress-bar" id="top-progress-bar"></div>
  </div>

  <!-- CONTAINER PRINCIPAL -->
  <div class="main-container">

    <!-- STEP1 : Choix d’objectif -->
    <div class="box" id="step1">
      <div class="box-header">
        <!-- Bouton retour masqué en première étape -->
        <button class="back-btn hidden-visibility" id="back-btn1" aria-label="Retour"><i class="fas fa-arrow-up"></i></button>
        <div class="box-title">Choisis ton objectif</div>
      </div>
      <div class="objectives-container">
        <button data-category="convaincre">Convaincre</button>
        <button data-category="inspirer">Inspirer</button>
        <button data-category="lacher-prise">Lâcher prise</button>
        <button data-category="toast">Porter un toast</button>
        <button data-category="repartie">Avoir de la répartie</button>
        <button data-category="vendre">Vendre</button>
        <button data-category="conflit">Gérer un conflit</button>
        <button data-category="diction">Diction</button>
        <button data-category="entretien">Réussir son entretien</button>
      </div>
      <div id="objective-error" class="error-message">
        Sélectionne un objectif avant de continuer.
      </div>
      <!-- Bouton suivant de la box STEP1 -->
      <button class="next-btn" id="next-btn1" aria-label="Étape suivante">
        <i class="fas fa-arrow-down"></i>
      </button>
    </div>

    <!-- STEP2 : Génère un sujet d’improvisation (nouvelle box) -->
    <div class="box" id="step2-subject">
      <div class="box-header">
        <button class="back-btn" id="back-btn-subject" aria-label="Retour à l'étape précédente">
          <i class="fas fa-arrow-up"></i>
        </button>
        <div class="box-title">Génère un sujet d'improvisation</div>
      </div>
      <!-- Rappel de l'objectif choisi (sera mis à jour dynamiquement) -->
      <p id="objective-reminder">Objectif choisi : </p>
      <!-- Bouton pour générer le sujet -->
      <button id="generate-subject-btn" aria-label="Générer un sujet">Générer</button>
      <!-- Conteneur qui affichera le sujet généré -->
      <div id="subject-result"></div>
      <div id="subject-error" class="error-message"></div>
      <!-- Bouton suivant pour passer à l'étape suivante -->
      <button class="next-btn" id="next-btn-subject" aria-label="Étape suivante">
        <i class="fas fa-arrow-down"></i>
      </button>
    </div>

    <!-- STEP3 : Vidéo, enregistrement, etc. (anciennement STEP2) -->
    <div class="box" id="step2-video">
      <div class="box-header">
        <button class="back-btn" id="back-btn-video" aria-label="Retour à l'étape précédente">
          <i class="fas fa-arrow-up"></i>
        </button>
        <div class="box-title">Lance ton improvisation</div>
      </div>
      <!-- Affichage du sujet généré transmis depuis la box STEP2 -->
      <div id="subject-display-video"></div>
      <div class="video-box">
        <video id="preview" autoplay muted></video>
        <div class="video-text" id="video-text">
          Ici va s'enregistrer ton improvisation vidéo. <br>
          Lorsque tu es prêt, clique sur "Démarrer ton impro" ci-dessous.<br><br>
          NB : ta vidéo est stockée sur ton appareil. Aucun enregistrement n'est conservé par Letmotiv.
        </div>
        <div class="recording-indicator" id="recording-indicator">
          <span class="dot"></span> Enregistrement en cours
        </div>
        <div class="countdown" id="countdown">1:59</div>
        <div class="initial-countdown-overlay" id="initial-countdown-overlay">
          <div class="initial-countdown" id="initial-countdown">3</div>
        </div>
      </div>
      <div class="impro-actions">
        <button id="start-btn" aria-label="Démarrer l'improvisation">
          Démarrer ton impro <i class="fas fa-video"></i>
        </button>
        <button id="stop-btn" class="hidden-btn" aria-label="Arrêter l'improvisation">
          Arrêter ton impro <i class="fas fa-stop"></i>
        </button>
        <button id="restart-btn" class="hidden-btn" aria-label="Récommencer l'improvisation">
          Récommencer ton impro <i class="fas fa-redo"></i>
        </button>
      </div>
      <div id="impro-error" class="error-message"></div>
      <!-- Bouton suivant pour passer à l'étape suivante -->
      <button class="next-btn" id="next-btn-video" aria-label="Étape suivante">
        <i class="fas fa-arrow-down"></i>
      </button>
    </div>

    <!-- STEP4 : Partage sur LinkedIn + Options de progression (inchangée) -->
    <div class="box" id="step4">
      <div class="box-header">
        <button class="back-btn" id="back-btn4" aria-label="Retour à l'étape précédente">
          <i class="fas fa-arrow-up"></i>
        </button>
        <div class="box-title">Partage ton expérience</div>
      </div>
      <p>
        Encourage d'autres personnes à relever le défi ! Montre ton courage et inspire les autres 
        à s'améliorer en improvisation ! <b>#ChallengeImproLetmotiv</b>
      </p>
      <a
        id="linkedin-share-button"
        href="https://www.linkedin.com/shareArticle?mini=true&url=https://letmotiv-simulateur.fr"
        target="_blank"
        rel="noopener noreferrer"
        class="linkedin-share-button"
        aria-label="Partager sur LinkedIn"
      >
        <i class="fab fa-linkedin"></i> Partager sur LinkedIn
      </a>
      <div class="progression-buttons">
        <p>Tu souhaites progresser rapidement et efficacement dans la prise de parole en public ?</p>
        <a 
          href="https://alexetpierre.systeme.io/inscription"
          target="_blank"
          rel="noopener noreferrer"
          class="btn"
          aria-label="S'inscrire à la formation en ligne"
        >
          <i class="fas fa-laptop"></i> Suis notre formation en ligne
        </a>
        <a
          href="https://www.letmotiv.fr/offres-particulier/coaching-prise-de-parole"
          target="_blank"
          rel="noopener noreferrer"
          class="btn"
          aria-label="Réserver un coaching"
        >
          <i class="fas fa-chalkboard-teacher"></i> Réserve un coaching
        </a>
      </div>
      <!-- Bouton suivant -->
      <button class="next-btn" id="next-btn4" aria-label="Étape suivante">
        <i class="fas fa-arrow-down"></i>
      </button>
    </div>

    <!-- STEP5 : Analyse ta prestation (inchangée) -->
    <div class="box" id="step3">
      <div class="box-header">
        <button class="back-btn" id="back-btn3" aria-label="Retour à l'étape précédente">
          <i class="fas fa-arrow-up"></i>
        </button>
        <div class="box-title">Analyse ta prestation</div>
      </div>
      <!-- Contenu de l'analyse (formulaire, champs, etc.) inchangé -->
      <div class="download-section">
        <div class="download-section-accent">
          <h2>Obtiens gratuitement ta prestation en vidéo et la grille d'analyse Letmotiv</h2>
          <p class="subtitle">Analyse et évalue ton improvisation grâce au document Letmotiv. </p>
          <p class="reassure">
            N'hésite pas à t'entraîner et refaire des improvisations pour progresser sur tes axes d'améliorations. 
          </p>
        </div>
        <div class="download-fields">
          <div class="input-group">
            <label for="prenom">Prénom :</label>
            <input type="text" id="prenom" placeholder="Votre prénom" aria-label="Prénom"/>
            <div id="prenom-error" class="error-message"></div>
          </div>
          <div class="input-group">
            <label for="email">Email :</label>
            <input type="email" id="email" placeholder="Votre email" aria-label="Email"/>
            <div id="email-error" class="error-message"></div>
          </div>
        </div>
        <div class="call-to-action">
          <button id="validate-form-btn" aria-label="Valider les informations">
            Valider et voir mes ressources
          </button>
        </div>
        <div id="success-message" class="success-message" style="display: none;">
          Merci ! Vos informations ont été enregistrées et vos ressources sont prêtes à être téléchargées.
        </div>
        <div class="download-buttons" id="download-buttons">
          <button id="download-video-btn" aria-label="Télécharge ta vidéo">
            <i class="fas fa-download"></i> Télécharge ta vidéo (mp4)
          </button>
          <button id="download-pdf-btn" aria-label="Télécharge la grille d'évaluation">
            <i class="fas fa-download"></i> Télécharge la grille d'évaluation (pdf)
          </button>
        </div>
      </div>
    </div>

  </div>

  <!-- SCRIPT -->
  <script>
    /***********************
     * 1) Gestion des étapes
     * Le parcours est désormais composé de 5 étapes :
     *   1 : Box Objectifs
     *   2 : Box Sujet (génération)
     *   3 : Box Vidéo Impro
     *   4 : Box Partage
     *   5 : Box Analyse
     ***********************/
    const boxes = {
      1: document.getElementById('step1'),
      2: document.getElementById('step2-subject'),
      3: document.getElementById('step2-video'),
      4: document.getElementById('step4'),
      5: document.getElementById('step3')
    };

    // Mise à jour de la barre de progression : 5 étapes => 20% chacune
    const topProgressBar = document.getElementById('top-progress-bar');
    function updateProgressBar(step) {
      const progress = step * 20;
      topProgressBar.style.width = `${progress}%`;
    }
    updateProgressBar(0);

    // Fonction d'affichage avec animations
    function showBox(current, next) {
      if (!boxes[current] || !boxes[next]) return;
      boxes[current].classList.remove('active', 'slide-from-bottom', 'slide-from-top');
      boxes[next].classList.add('active');
      if (next > current) {
        boxes[next].classList.add('slide-from-bottom');
      } else {
        boxes[next].classList.add('slide-from-top');
      }
      updateProgressBar(next);
      const header = document.querySelector('.header');
      const headerHeight = header ? header.offsetHeight : 0;
      const boxPosition = boxes[next].getBoundingClientRect().top + window.scrollY - headerHeight - 20;
      window.scrollTo({ top: boxPosition, behavior: 'smooth' });
    }

    // Gestion de la boîte d'introduction
    document.getElementById('start-intro-btn').addEventListener('click', () => {
      const introBox = document.getElementById('intro-box');
      introBox.style.animation = 'fadeOut 0.5s ease forwards';
      setTimeout(() => {
        introBox.style.display = 'none';
        boxes[1].classList.add('active', 'slide-from-bottom');
        updateProgressBar(1);
      }, 500);
    });

    /***********************
     * 2) STEP1 : Objectifs
     ***********************/
    // Lorsqu'on clique sur "Suivant" dans la box STEP1, on vérifie que l'utilisateur a bien sélectionné un objectif.
    document.getElementById('next-btn1').addEventListener('click', () => {
      const selected = document.querySelector('.objectives-container .selected-objective');
      if (!selected) {
        const errorDiv = document.getElementById('objective-error');
        errorDiv.textContent = "Sélectionne un objectif avant de continuer.";
        errorDiv.style.display = 'block';
        return;
      }
      // Met à jour le rappel dans la box Sujet
      document.getElementById('objective-reminder').textContent = "Objectif choisi : " + selected.textContent;
      // Conserve la catégorie dans une variable globale pour le chargement des sujets
      currentCategory = selected.dataset.category;
      showBox(1, 2);
    });

    // Gestion de la sélection d'objectif (pour l'effet visuel)
    const objectivesButtons = document.querySelectorAll('.objectives-container button');
    let currentCategory = null;
    objectivesButtons.forEach(button => {
      button.addEventListener('click', () => {
        objectivesButtons.forEach(btn => btn.classList.remove('selected-objective'));
        button.classList.add('selected-objective');
        // Masquer les éventuels messages d'erreur
        document.getElementById('objective-error').style.display = 'none';
      });
    });

    /***********************
     * 3) STEP2 : Génération du sujet
     ***********************/
    let currentSubject = "";
    const subjectsCache = {
      convaincre: null,
      inspirer: null,
      'lacher-prise': null,
      toast: null,
      repartie: null,
      vendre: null,
      conflit: null,
      diction: null,
      entretien: null
    };
    const txtFilesByCategory = {
      convaincre:   "https://raw.githubusercontent.com/Citizen11bf/letmotiv/data/convaincre.txt",
      inspirer:     "https://raw.githubusercontent.com/Citizen11bf/letmotiv/data/inspirer.txt",
      'lacher-prise': "https://raw.githubusercontent.com/Citizen11bf/letmotiv/data/lacher_prise.txt",
      toast:        "https://raw.githubusercontent.com/Citizen11bf/letmotiv/data/toast.txt",
      repartie:     "https://raw.githubusercontent.com/Citizen11bf/letmotiv/data/repartie.txt",
      vendre:       "https://raw.githubusercontent.com/Citizen11bf/letmotiv/data/vendre.txt",
      conflit:      "https://raw.githubusercontent.com/Citizen11bf/letmotiv/data/gerer_un_conflit.txt",
      diction:      "https://raw.githubusercontent.com/Citizen11bf/letmotiv/data/diction.txt",
      entretien:    "https://raw.githubusercontent.com/Citizen11bf/letmotiv/data/entretien.txt"
    };

    async function loadSubjects(category) {
      const filePath = txtFilesByCategory[category];
      if (!filePath) return [];
      try {
        const response = await fetch(filePath);
        if (!response.ok) {
          console.error("Erreur fetch:", filePath);
          return [];
        }
        const text = await response.text();
        const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
        subjectsCache[category] = lines;
        return lines;
      } catch (err) {
        console.error("Erreur fetch: ", err);
        return [];
      }
    }

    // Génération du sujet dans la box STEP2
    document.getElementById('generate-subject-btn').addEventListener('click', async () => {
      if (!currentCategory) {
        document.getElementById('objective-error').textContent = "Merci de sélectionner un objectif avant de générer un sujet.";
        document.getElementById('objective-error').style.display = 'block';
        return;
      }
      // Charge les sujets s'ils ne le sont pas déjà
      if (subjectsCache[currentCategory] === null) {
        await loadSubjects(currentCategory);
      }
      const subjects = subjectsCache[currentCategory];
      if (!subjects || subjects.length === 0) {
        document.getElementById('subject-result').textContent = "Désolé, aucun sujet n'est disponible pour le moment. Veuillez réessayer plus tard.";
        currentSubject = "";
        return;
      }
      const randomIndex = Math.floor(Math.random() * subjects.length);
      currentSubject = subjects[randomIndex];
      document.getElementById('subject-result').textContent = "Sujet généré : " + currentSubject;
      document.getElementById('subject-error').style.display = 'none';
    });

    // Bouton "Suivant" de la box STEP2 : passe à la box STEP3 (Vidéo)
    document.getElementById('next-btn-subject').addEventListener('click', () => {
      if (!currentSubject) {
        const subjectError = document.getElementById('subject-error');
        subjectError.textContent = "Génère un sujet avant de continuer.";
        subjectError.style.display = 'block';
        return;
      }
      showBox(2, 3);
      // Met à jour l'affichage du sujet dans la box vidéo
      document.getElementById('subject-display-video').textContent = "Sujet : " + currentSubject;
    });

    /***********************
     * 4) STEP3 : Enregistrement vidéo (anciennement STEP2)
     ***********************/
    let improStarted = false;
    let mediaRecorderInstance;
    let recordedChunks = [];
    const preview = document.getElementById('preview');
    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');
    const restartBtn = document.getElementById('restart-btn');
    const recordingIndicator = document.getElementById('recording-indicator');
    const countdownElement = document.getElementById('countdown');
    const videoText = document.getElementById('video-text');
    const initialCountdownOverlay = document.getElementById('initial-countdown-overlay');
    const initialCountdown = document.getElementById('initial-countdown');

    let countdown;
    let videoURL = "";
    let timerInterval;
    let timeRemaining = 120; // 2 minutes

    async function startImpro() {
      if (!currentSubject) {
        document.getElementById('impro-error').textContent = "Tu dois générer un sujet avant de démarrer l'improvisation.";
        document.getElementById('impro-error').style.display = 'block';
        return;
      }
      if (typeof MediaRecorder === 'undefined' || !navigator.mediaDevices?.getUserMedia) {
        document.getElementById('impro-error').textContent = "Désolé, l'enregistrement vidéo n'est pas supporté par votre navigateur.";
        document.getElementById('impro-error').style.display = 'block';
        return;
      }
      if (!confirm("Votre webcam va se lancer pour démarrer l'improvisation. Voulez-vous continuer ?")) {
        return;
      }
      startInitialCountdown();
    }

    function startInitialCountdown() {
      let count = 5;
      initialCountdown.textContent = count;
      initialCountdownOverlay.style.display = 'flex';
      countdown = setInterval(() => {
        count--;
        if (count > 0) {
          initialCountdown.textContent = count;
        } else {
          clearInterval(countdown);
          initialCountdownOverlay.style.display = 'none';
          initiateRecording();
        }
      }, 1000);
    }

    async function initiateRecording() {
      const stream = await setupCamera();
      if (!stream) return;
      if (!window.MediaRecorder || typeof MediaRecorder.isTypeSupported === 'undefined') {
        document.getElementById('impro-error').textContent = "Votre navigateur ne supporte pas l'enregistrement vidéo. Essayez Chrome ou Firefox.";
        document.getElementById('impro-error').style.display = 'block';
        return;
      }
      mediaRecorderInstance = new MediaRecorder(stream);
      recordedChunks = [];
      mediaRecorderInstance.ondataavailable = (event) => {
        if (event.data.size > 0) { recordedChunks.push(event.data); }
      };
      mediaRecorderInstance.onstop = () => {
        const videoBlob = new Blob(recordedChunks, { type: 'video/mp4' });
        videoURL = URL.createObjectURL(videoBlob);
        stream.getTracks().forEach(t => t.stop());
        videoText.innerHTML = "Improvisation terminée.";
        videoText.style.display = 'block';
        document.getElementById('impro-error').style.display = 'none';
        recordingIndicator.style.display = 'none';
        clearInterval(timerInterval);
        improStarted = true;
      };
      mediaRecorderInstance.start();
      recordingIndicator.style.display = 'flex';
      videoText.style.display = 'none';
      startBtn.classList.add('hidden-btn');
      stopBtn.classList.remove('hidden-btn');
      stopBtn.disabled = false;
      restartBtn.classList.add('hidden-btn');
      startTimer();
    }

    async function setupCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        preview.srcObject = stream;
        return stream;
      } catch (error) {
        const improErrorDiv = document.getElementById('impro-error');
        if (error.name === 'NotAllowedError') {
          improErrorDiv.textContent = "Vous avez refusé l'accès à la webcam. Veuillez autoriser l'accès.";
        } else if (error.name === 'NotFoundError') {
          improErrorDiv.textContent = "Aucune caméra/micro détectés.";
        } else {
          improErrorDiv.textContent = "Erreur : Impossible d'accéder à la webcam.";
        }
        improErrorDiv.style.display = 'block';
        console.error(error);
        return null;
      }
    }

    function startTimer() {
      timeRemaining = 120;
      updateCountdownDisplay();
      timerInterval = setInterval(() => {
        timeRemaining--;
        if (timeRemaining >= 0) { updateCountdownDisplay(); }
        if (timeRemaining < 0) {
          clearInterval(timerInterval);
          if (mediaRecorderInstance && mediaRecorderInstance.state === 'recording') {
            mediaRecorderInstance.stop();
            restartBtn.classList.remove('hidden-btn');
          }
        }
      }, 1000);
    }
    function updateCountdownDisplay() {
      const minutes = Math.floor(timeRemaining / 60);
      const seconds = timeRemaining % 60;
      countdownElement.textContent = `${minutes}:${seconds < 10 ? '0' + seconds : seconds}`;
      countdownElement.style.display = 'block';
    }

    startBtn.addEventListener('click', startImpro);
    stopBtn.addEventListener('click', () => {
      if (mediaRecorderInstance && mediaRecorderInstance.state === 'recording') {
        mediaRecorderInstance.stop();
        clearInterval(countdown);
        clearInterval(timerInterval);
        stopBtn.classList.add('hidden-btn');
        stopBtn.disabled = true;
        restartBtn.classList.remove('hidden-btn');
        recordingIndicator.style.display = 'none';
      }
    });
    restartBtn.addEventListener('click', () => {
      restartBtn.classList.add('hidden-btn');
      videoText.innerHTML = "Ici va s'enregistrer ton improvisation en vidéo. <br> Lorsque tu es prêt, clique sur le bouton \"Démarrer ton impro\". <br><br> NB : ta vidéo est stockée directement sur ton appareil. Aucun enregistrement n'est conservé par Letmotiv.";
      videoText.style.display = 'block';
      improStarted = false;
      startImpro();
    });

    /***********************
     * 5) STEP4 et STEP5 : Téléchargements et envoi des données (inchangés)
     ***********************/
    const validateFormBtn = document.getElementById('validate-form-btn');
    const prenomInput = document.getElementById('prenom');
    const emailInput = document.getElementById('email');
    const prenomError = document.getElementById('prenom-error');
    const emailError = document.getElementById('email-error');
    const downloadButtons = document.getElementById('download-buttons');
    const downloadVideoBtn = document.getElementById('download-video-btn');
    const downloadPdfBtn = document.getElementById('download-pdf-btn');

    validateFormBtn.addEventListener('click', () => {
      const prenomValue = prenomInput.value.trim();
      const emailValue = emailInput.value.trim();
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      const prenomRegex = /^[A-Za-zÀ-ÿ '-]+$/;

      let valid = true;
      prenomError.style.display = 'none';
      emailError.style.display = 'none';

      if (!prenomValue || !prenomRegex.test(prenomValue)) {
        prenomError.textContent = "Entre un prénom valide (sans chiffres ni caractères spéciaux).";
        prenomError.style.display = 'block';
        valid = false;
      }
      if (!emailValue) {
        emailError.textContent = "Merci de renseigner ton email pour continuer.";
        emailError.style.display = 'block';
        valid = false;
      } else if (!emailRegex.test(emailValue)) {
        emailError.textContent = "Entre une adresse email valide.";
        emailError.style.display = 'block';
        valid = false;
      }
      if (!valid) return;

      document.getElementById('hidden-prenom').value = prenomValue;
      document.getElementById('hidden-email').value = emailValue;
      document.getElementById('hidden-google-form').submit();

      downloadButtons.classList.add('show');
      const successMessage = document.getElementById('success-message');
      successMessage.style.display = 'block';
      successMessage.classList.add('show');
      setTimeout(() => {
        successMessage.classList.remove('show');
        successMessage.style.display = 'none';
      }, 5000);
      document.getElementById('next-btn4').disabled = false;
    });

    downloadVideoBtn.addEventListener('click', () => {
      if (!videoURL) {
        document.getElementById('impro-error').textContent = "La vidéo n'est pas encore prête ou pas enregistrée.";
        document.getElementById('impro-error').style.display = 'block';
        return;
      }
      const link = document.createElement('a');
      link.href = videoURL;
      link.download = 'Letmotiv_Improvisation.mp4';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    downloadPdfBtn.addEventListener('click', () => {
      const link = document.createElement('a');
      link.href = "https://drive.google.com/uc?export=download&id=1pKif7hwkdSQRXLv6uoSQawCs3DIIcb70";
      link.download = "Questions_Evaluation.pdf";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    /***********************
     * BACK BUTTONS pour STEP2 et STEP3
     ***********************/
    document.getElementById('back-btn-subject').addEventListener('click', () => {
      showBox(2, 1);
    });
    document.getElementById('back-btn-video').addEventListener('click', () => {
      showBox(3, 2);
    });
    // Les autres back buttons (step4 et step5) restent inchangés.
  </script>
</body>
</html>
